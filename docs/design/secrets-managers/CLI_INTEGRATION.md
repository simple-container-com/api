# CLI Integration: Advanced Secrets Management System

## üñ•Ô∏è Overview

The Advanced Secrets Management System integrates seamlessly with Simple Container's existing CLI commands while adding new capabilities for managing external secrets managers and SSH key registries. All existing workflows continue to work unchanged, with enhanced functionality available through configuration.

## üîÑ Backward Compatibility

### Existing Commands Work Unchanged

All current Simple Container secrets commands continue to function exactly as before:

```bash
# ‚úÖ All existing commands work unchanged
sc secrets init
sc secrets list
sc secrets add .sc/stacks/my-app/secrets.yaml
sc secrets reveal
sc secrets hide
sc secrets allow "$(cat ~/.ssh/id_rsa.pub)"
sc secrets disallow "$(cat ~/.ssh/id_rsa.pub)"
sc secrets allowed-keys
```

### Transparent Secret Resolution

When external secrets managers are configured, secret resolution becomes transparent:

```bash
# Same command, but now checks:
# 1. Vault (if configured)
# 2. AWS Secrets Manager (if configured) 
# 3. secrets.yaml (fallback)
sc secrets reveal
```

## üÜï New CLI Capabilities

### Secrets Manager Management

```bash
# Configure external secrets managers
sc secrets manager add vault \
  --address https://vault.company.com \
  --auth-method kubernetes \
  --role simple-container-prod

sc secrets manager add aws-secrets-manager \
  --region us-east-1 \
  --prefix simple-container/

sc secrets manager list
sc secrets manager test vault
sc secrets manager remove aws-secrets-manager
```

### SSH Key Registry Management

```bash
# Configure SSH key sources
sc secrets ssh-keys add-source github-org \
  --org your-company \
  --teams platform,devops \
  --api-token-secret github-api-token

sc secrets ssh-keys add-source file \
  --path /etc/simple-container/authorized_keys \
  --watch

sc secrets ssh-keys add-source url \
  --url https://keys.company.com/api/authorized_keys \
  --header "Authorization: Bearer ${secret:keys-api-token}"

# Manage SSH key sources
sc secrets ssh-keys list-sources
sc secrets ssh-keys refresh
sc secrets ssh-keys test-source github-org
sc secrets ssh-keys remove-source file-source-1
```

### Enhanced Secret Operations

```bash
# List secrets from all sources (context-aware)
sc secrets list --source vault --stack production-api --environment production
sc secrets list --source aws-secrets-manager --stack production-api
sc secrets list --all-sources

# Get secret with source information and context
sc secrets get database-password --show-source --stack production-api --environment production

# Set secret in external manager with context
sc secrets set database-password "new-secure-password" --manager vault --stack production-api --environment production

# Test secret resolution hierarchy with context
sc secrets test-resolution database-password --stack production-api --environment production
```

## üîß Enhanced Commands

### Enhanced `sc secrets reveal`

```bash
# Basic usage (unchanged)
sc secrets reveal

# New verbose mode shows source information with context
sc secrets reveal --verbose
# Output:
# üîç Resolving secrets for production-api/production...
# ‚úÖ database-password (from vault:yourorg/production-api/production/database-password)
# ‚úÖ jwt-secret (from aws-secrets-manager:yourorg/production-api/production/jwt-secret)
# ‚úÖ stripe-api-key (from secrets.yaml)
# 
# All secrets resolved successfully!

# Show resolution details with context paths
sc secrets reveal --debug
# Output:
# üîç Resolving secret: database-password
#   ‚Ü≥ Context: yourorg/production-api/production
#   ‚Ü≥ Trying vault at secret/yourorg/production-api/production/database-password... ‚úÖ Found
# üîç Resolving secret: jwt-secret  
#   ‚Ü≥ Context: yourorg/production-api/production
#   ‚Ü≥ Trying vault at secret/yourorg/production-api/production/jwt-secret... ‚ùå Not found
#   ‚Ü≥ Trying aws-secrets-manager at yourorg/production-api/production/jwt-secret... ‚úÖ Found
# üîç Resolving secret: shared-config
#   ‚Ü≥ Context: yourorg/production-api/production
#   ‚Ü≥ Trying vault at secret/yourorg/production-api/production/shared-config... ‚ùå Not found
#   ‚Ü≥ Trying vault at secret/yourorg/shared/production/shared-config... ‚úÖ Found
```

### Enhanced `sc secrets list`

```bash
# Enhanced output with source information
sc secrets list
# Output:
# üìã Available secrets:
# 
# From vault (3 secrets):
#   ‚Ä¢ database-password
#   ‚Ä¢ redis-password  
#   ‚Ä¢ jwt-secret
#   
# From aws-secrets-manager (2 secrets):
#   ‚Ä¢ stripe-api-key
#   ‚Ä¢ sendgrid-api-key
#   
# From secrets.yaml (1 secret):
#   ‚Ä¢ legacy-secret
#
# Total: 6 secrets across 3 sources

# Filter by source
sc secrets list --source vault
sc secrets list --source secrets.yaml

# Show detailed information
sc secrets list --detailed
# Output includes metadata, creation dates, versions
```

### Enhanced `sc secrets allowed-keys`

```bash
# Enhanced output with SSH key sources
sc secrets allowed-keys
# Output:
# üîë Authorized SSH Keys:
#
# From github-org:your-company (5 keys):
#   ‚Ä¢ SHA256:abc123... john@company.com (github)
#   ‚Ä¢ SHA256:def456... jane@company.com (github)
#   ‚Ä¢ SHA256:ghi789... mike@company.com (github)
#
# From file:/etc/simple-container/authorized_keys (2 keys):
#   ‚Ä¢ SHA256:jkl012... admin@server (local)
#   ‚Ä¢ SHA256:mno345... backup@server (local)
#
# From url:https://keys.company.com/api/authorized_keys (1 key):
#   ‚Ä¢ SHA256:pqr678... service@company.com (api)
#
# Total: 8 keys from 3 sources
# Last refresh: 2024-01-15 14:30:00 UTC

# Force refresh from all sources
sc secrets allowed-keys --refresh

# Show detailed key information
sc secrets allowed-keys --detailed
```

## üöÄ Deployment Integration

### Context-Aware Deployment

During deployment, Simple Container automatically provides context information to secrets managers based on the deployment parameters:

```bash
# Context is automatically derived from deployment parameters
sc deploy -s production-api -e production

# Context information used:
# - ClientStack: "production-api" (from -s flag)
# - Environment: "production" (from -e flag) 
# - ParentStack: "yourorg/infrastructure" (from client.yaml)
# - Organization: "yourorg" (extracted from parent stack)
```

### Enhanced `sc deploy` with Context-Aware Resolution

```bash
# Same command, enhanced secret resolution with context
sc deploy -s production-api -e production

# During deployment, secrets are resolved with context:
# 1. Try external managers with context paths
# 2. Try shared secret paths for common configurations
# 3. Fallback to secrets.yaml
# 4. Clear error messages with context information

# Deployment output shows context-aware resolution
# üîç Resolving secrets for production-api/production...
# ‚úÖ DATABASE_URL (from vault:yourorg/production-api/production/database-password)
# ‚úÖ STRIPE_API_KEY (from aws-secrets-manager:yourorg/production-api/production/stripe-api-key)  
# ‚úÖ SHARED_JWT_SECRET (from vault:yourorg/shared/production/jwt-secret)
# ‚úÖ LEGACY_CONFIG (from secrets.yaml)
# üöÄ Starting deployment...
```

### Pre-deployment Secret Validation

```bash
# Validate all required secrets are available
sc secrets validate --stack production-api

# Output:
# üîç Validating secrets for stack: production-api
# ‚úÖ DATABASE_URL (required) - found in vault
# ‚úÖ STRIPE_API_KEY (required) - found in aws-secrets-manager
# ‚ùå SENDGRID_API_KEY (required) - not found in any source
# ‚ö†Ô∏è  OPTIONAL_API_KEY (optional) - not found
#
# ‚ùå Validation failed: 1 required secret missing

# Fix mode suggests solutions
sc secrets validate --stack production-api --fix
# Output:
# ‚ùå SENDGRID_API_KEY missing. Suggestions:
#   ‚Ä¢ Add to vault: sc secrets set SENDGRID_API_KEY "your-key" --manager vault
#   ‚Ä¢ Add to secrets.yaml: sc secrets add .sc/stacks/production-api/secrets.yaml
```

## üîß Configuration Commands

### Server Configuration Management

```bash
# View current secrets configuration
sc config show secrets

# Output:
# üìã Secrets Configuration:
#
# Managers (2 configured):
#   1. vault (priority 1)
#      ‚Ä¢ Address: https://vault.company.com
#      ‚Ä¢ Auth: kubernetes (role: simple-container-prod)
#      ‚Ä¢ Status: ‚úÖ Connected
#
#   2. aws-secrets-manager (priority 2)  
#      ‚Ä¢ Region: us-east-1
#      ‚Ä¢ Prefix: simple-container/
#      ‚Ä¢ Status: ‚úÖ Connected
#
# SSH Key Sources (3 configured):
#   ‚Ä¢ github-org:your-company (‚úÖ Active, 15 keys)
#   ‚Ä¢ file:/etc/simple-container/authorized_keys (‚úÖ Active, 2 keys)
#   ‚Ä¢ url:https://keys.company.com/api/authorized_keys (‚ùå Unreachable)
#
# Cache Settings:
#   ‚Ä¢ Memory: 50MB max, 15min TTL
#   ‚Ä¢ Disk: 200MB max, encrypted

# Test configuration
sc config test secrets

# Health check all components  
sc secrets health
```

### Migration Tools

```bash
# Migrate secrets from secrets.yaml to external manager
sc secrets migrate \
  --from secrets.yaml \
  --to vault \
  --stack production-api \
  --dry-run

# Output:
# üîÑ Migration Plan (DRY RUN):
# 
# Will migrate 5 secrets from secrets.yaml to vault:
#   ‚Ä¢ database-password ‚Üí secret/simple-container/production-api/database-password
#   ‚Ä¢ jwt-secret ‚Üí secret/simple-container/production-api/jwt-secret
#   ‚Ä¢ stripe-api-key ‚Üí secret/simple-container/production-api/stripe-api-key
#   ‚Ä¢ sendgrid-api-key ‚Üí secret/simple-container/production-api/sendgrid-api-key
#   ‚Ä¢ redis-password ‚Üí secret/simple-container/production-api/redis-password
#
# After migration:
#   ‚Ä¢ secrets.yaml will be backed up to .sc/stacks/production-api/secrets.yaml.backup
#   ‚Ä¢ client.yaml references will remain unchanged
#   ‚Ä¢ Secret resolution will use vault first, then fall back to secrets.yaml

# Execute migration
sc secrets migrate \
  --from secrets.yaml \
  --to vault \
  --stack production-api \
  --backup

# Rollback migration if needed
sc secrets migrate rollback \
  --stack production-api \
  --backup-file .sc/stacks/production-api/secrets.yaml.backup.20240115-143000
```

## üîç Diagnostic Commands

### Secret Resolution Debugging

```bash
# Debug why a secret isn't resolving
sc secrets debug database-password

# Output:
# üîç Debugging secret resolution: database-password
#
# Resolution hierarchy:
#   1. vault (priority 1)
#      ‚Ä¢ Checking path: secret/simple-container/database-password
#      ‚Ä¢ Status: ‚ùå Secret not found
#      ‚Ä¢ Details: Path exists but no 'database-password' key
#
#   2. aws-secrets-manager (priority 2)  
#      ‚Ä¢ Checking name: simple-container/database-password
#      ‚Ä¢ Status: ‚ùå Connection failed
#      ‚Ä¢ Details: Access denied (check IAM permissions)
#
#   3. secrets.yaml (fallback)
#      ‚Ä¢ Checking file: .sc/stacks/production-api/secrets.yaml
#      ‚Ä¢ Status: ‚úÖ Found
#      ‚Ä¢ Details: Value available, encrypted
#
# Result: Secret found in secrets.yaml (fallback)
#
# Recommendations:
#   ‚Ä¢ Fix AWS IAM permissions to enable aws-secrets-manager
#   ‚Ä¢ Consider moving secret to vault for better security
#   ‚Ä¢ Check vault path configuration

# Test connectivity to secrets managers
sc secrets test-connectivity

# Output:
# üîó Testing secrets manager connectivity:
#
# vault:
#   ‚Ä¢ Connection: ‚úÖ Connected to https://vault.company.com
#   ‚Ä¢ Authentication: ‚úÖ Token valid (expires in 23h 45m)
#   ‚Ä¢ Permissions: ‚úÖ Can read/write to secret/simple-container/*
#
# aws-secrets-manager:
#   ‚Ä¢ Connection: ‚ùå Access denied
#   ‚Ä¢ IAM Role: arn:aws:iam::123456789012:role/simple-container-role
#   ‚Ä¢ Missing Permissions: secretsmanager:GetSecretValue
#   ‚Ä¢ Recommendation: Add SecretsManagerReadWrite policy
```

### SSH Key Registry Debugging

```bash
# Debug SSH key source issues
sc secrets ssh-keys debug

# Output:  
# üîç SSH Key Sources Debug:
#
# github-org:your-company:
#   ‚Ä¢ API Connection: ‚úÖ Connected to https://api.github.com
#   ‚Ä¢ Authentication: ‚úÖ Token valid
#   ‚Ä¢ Organization Access: ‚úÖ Can read your-company
#   ‚Ä¢ Team Access: ‚úÖ Can read teams: platform, devops
#   ‚Ä¢ Rate Limiting: ‚úÖ 4,950/5,000 requests remaining
#   ‚Ä¢ Last Refresh: 2024-01-15 14:25:00 UTC (5 min ago)
#   ‚Ä¢ Keys Retrieved: 15
#
# file:/etc/simple-container/authorized_keys:
#   ‚Ä¢ File Access: ‚úÖ File readable
#   ‚Ä¢ File Watcher: ‚úÖ Active
#   ‚Ä¢ Last Modified: 2024-01-15 09:30:00 UTC
#   ‚Ä¢ Keys Parsed: 2 valid, 0 invalid
#
# url:https://keys.company.com/api/authorized_keys:
#   ‚Ä¢ HTTP Connection: ‚ùå Connection timeout
#   ‚Ä¢ SSL Certificate: ‚úÖ Valid
#   ‚Ä¢ Authentication: ‚ö†Ô∏è  Untested (connection failed)
#   ‚Ä¢ Recommendation: Check network connectivity and firewall rules

# Test individual SSH key source
sc secrets ssh-keys test github-org
```

## üìä Monitoring and Observability

### Built-in Metrics Commands

```bash
# Show secrets management statistics
sc secrets stats

# Output:
# üìä Secrets Management Statistics:
#
# Resolution Performance (last 24h):
#   ‚Ä¢ Total Requests: 1,247
#   ‚Ä¢ Cache Hit Rate: 78.3%
#   ‚Ä¢ Average Response Time: 45ms
#   ‚Ä¢ P95 Response Time: 120ms
#
# Success Rates:
#   ‚Ä¢ vault: 98.2% (1,225/1,247)
#   ‚Ä¢ aws-secrets-manager: 94.1% (22/22 fallback requests)  
#   ‚Ä¢ secrets.yaml: 100% (0/0 fallback requests)
#
# SSH Key Registry:
#   ‚Ä¢ Total Keys: 17
#   ‚Ä¢ Last Refresh: 2024-01-15 14:25:00 UTC
#   ‚Ä¢ Refresh Success Rate: 100%
#   ‚Ä¢ Average Refresh Time: 3.2s

# Export metrics for monitoring systems
sc secrets stats --format prometheus
sc secrets stats --format json
```

### Health Monitoring

```bash
# Continuous health monitoring
sc secrets monitor

# Output (updates every 10 seconds):
# üîÑ Secrets Management Health Monitor
#
# [14:30:00] ‚úÖ All systems healthy
# [14:30:10] ‚úÖ All systems healthy  
# [14:30:20] ‚ö†Ô∏è  AWS Secrets Manager slow response (2.3s)
# [14:30:30] ‚ùå Vault connection failed (retrying...)
# [14:30:40] ‚úÖ Vault reconnected - all systems healthy

# Set up alerting  
sc secrets monitor --alert-webhook https://alerts.company.com/webhook
```

## üîí Security Commands

### Audit and Compliance

```bash
# Show secrets audit log
sc secrets audit

# Output:
# üìã Secrets Access Audit (last 7 days):
#
# 2024-01-15 14:25:33 | user@company.com | READ | database-password | vault | SUCCESS
# 2024-01-15 14:20:15 | user@company.com | READ | jwt-secret | aws-secrets-manager | SUCCESS
# 2024-01-15 14:15:42 | service-account | READ | stripe-api-key | vault | FAILED (not found)
# 2024-01-15 14:15:42 | service-account | READ | stripe-api-key | aws-secrets-manager | SUCCESS
# 2024-01-15 13:45:12 | admin@company.com | WRITE | new-api-key | vault | SUCCESS
#
# Summary: 145 accesses, 98.6% success rate

# Export audit log
sc secrets audit --format json --since 30d > secrets-audit.json

# Security scan
sc secrets security-scan

# Output:
# üîç Security Scan Results:
#
# ‚úÖ Encryption: All secrets encrypted at rest
# ‚úÖ Transport: All connections use TLS 1.2+
# ‚úÖ Authentication: All managers use strong authentication
# ‚ö†Ô∏è  Permissions: AWS role has broader permissions than needed
# ‚úÖ Key Management: SSH keys regularly rotated
# ‚ùå Compliance: Missing audit log retention policy
#
# Recommendations:
# ‚Ä¢ Restrict AWS IAM permissions to specific secret paths
# ‚Ä¢ Configure audit log retention (suggested: 2 years)
```

---

**Status**: This CLI integration design ensures seamless adoption of the Advanced Secrets Management System while maintaining full backward compatibility with existing Simple Container workflows and adding powerful new capabilities for enterprise secret management.
